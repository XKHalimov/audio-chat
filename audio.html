<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Radioaloqa Multi-User Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #0f172a 0%,
          #1e3a8a 50%,
          #0f172a 100%
        );
        color: #fff;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
      }

      .card {
        background: rgba(30, 41, 59, 0.9);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        border: 2px solid #3b82f6;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      h1 {
        font-size: 32px;
        color: #60a5fa;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      h2 {
        font-size: 24px;
        margin-bottom: 16px;
      }

      .mode-selector {
        text-align: center;
        max-width: 900px;
        margin: 80px auto;
      }

      .mode-selector h1 {
        justify-content: center;
        margin-bottom: 20px;
      }

      .mode-options {
        display: grid;
        gap: 20px;
        margin-top: 40px;
      }

      .mode-option {
        background: rgba(51, 65, 85, 0.8);
        padding: 30px;
        border-radius: 12px;
        border-left: 4px solid;
        transition: all 0.3s;
      }

      .mode-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      }

      .mode-option.server {
        border-color: #10b981;
      }

      .mode-option.client {
        border-color: #3b82f6;
      }

      .mode-option h3 {
        font-size: 24px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .mode-option p {
        color: #cbd5e1;
        margin-bottom: 16px;
      }

      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
      }

      button:hover:not(:disabled) {
        background: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      }

      button:disabled {
        background: #4b5563;
        cursor: not-allowed;
        opacity: 0.6;
      }

      button.success {
        background: #10b981;
      }

      button.success:hover:not(:disabled) {
        background: #059669;
      }

      button.danger {
        background: #ef4444;
      }

      button.danger:hover:not(:disabled) {
        background: #dc2626;
      }

      button.warning {
        background: #f97316;
      }

      button.warning:hover:not(:disabled) {
        background: #ea580c;
      }

      input {
        width: 100%;
        padding: 12px;
        background: rgba(15, 23, 42, 0.8);
        border: 2px solid #3b82f6;
        border-radius: 8px;
        color: white;
        font-size: 16px;
        margin-bottom: 16px;
      }

      input:focus {
        outline: none;
        border-color: #60a5fa;
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
      }

      .status-box {
        background: rgba(51, 65, 85, 0.8);
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 18px;
        font-weight: 500;
      }

      .status-connected {
        border: 2px solid #10b981;
        background: rgba(16, 185, 129, 0.1);
      }

      .status-disconnected {
        border: 2px solid #ef4444;
        background: rgba(239, 68, 68, 0.1);
      }

      .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }

      .grid-4 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .stat-box {
        background: rgba(51, 65, 85, 0.8);
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid;
        transition: all 0.3s;
      }

      .stat-box:hover {
        background: rgba(51, 65, 85, 1);
        transform: translateX(4px);
      }

      .stat-label {
        font-size: 14px;
        color: #cbd5e1;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: bold;
      }

      .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
      }

      .connection-id {
        background: rgba(15, 23, 42, 0.9);
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #10b981;
        margin-bottom: 20px;
      }

      .connection-id-label {
        font-size: 14px;
        color: #10b981;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .connection-id-value {
        font-size: 24px;
        font-family: "Courier New", monospace;
        color: #22c55e;
        word-break: break-all;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }

      .copy-btn {
        padding: 8px 16px;
        font-size: 14px;
        width: auto;
      }

      .info-box {
        background: rgba(202, 138, 4, 0.2);
        border: 2px solid #ca8a04;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
      }

      .info-box h4 {
        color: #fbbf24;
        margin-bottom: 12px;
      }

      .info-box ol {
        color: #cbd5e1;
        padding-left: 20px;
      }

      .info-box li {
        margin-bottom: 8px;
      }

      .user-list {
        display: grid;
        gap: 16px;
      }

      .user-card {
        background: rgba(15, 23, 42, 0.6);
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
      }

      .user-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          transparent 0%,
          rgba(59, 130, 246, 0.05) 100%
        );
        opacity: 0;
        transition: opacity 0.3s;
      }

      .user-card:hover {
        background: rgba(15, 23, 42, 0.9);
        transform: translateX(6px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      }

      .user-card:hover::before {
        opacity: 1;
      }

      .user-card.self {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.05);
      }

      .user-card.speaking {
        border-color: #22c55e;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(34, 197, 94, 0);
        }
      }

      .user-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        position: relative;
      }

      .user-name {
        font-size: 20px;
        font-weight: 600;
        color: #e2e8f0;
        margin-bottom: 4px;
      }

      .user-status {
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
      }

      .status-indicator.active {
        background: #10b981;
        animation: blink 1.5s infinite;
      }

      .status-indicator.inactive {
        background: #64748b;
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }

      .user-stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .user-stat {
        text-align: center;
        padding: 8px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
      }

      .user-stat-label {
        font-size: 11px;
        color: #94a3b8;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .user-stat-value {
        font-size: 18px;
        font-weight: 700;
        color: #e2e8f0;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #64748b;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .volume-meter {
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
      }

      .volume-meter-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #22c55e, #10b981);
        border-radius: 4px;
        transition: width 0.1s;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 1200px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        h1 {
          font-size: 24px;
        }

        .connection-id-value {
          font-size: 18px;
        }

        .user-stats-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Mode Selection Screen -->
      <div id="modeSelector" class="mode-selector">
        <div class="card">
          <h1>
            <span>üì°</span>
            Radioaloqa Multi-User Chat
          </h1>
          <p style="color: #cbd5e1; margin-top: 16px; font-size: 18px">
            Ko'p userli audio chat va signal tahlili tizimi
          </p>

          <div class="mode-options">
            <div class="mode-option server">
              <h3>
                <span>üñ•Ô∏è</span>
                Server rejimi (Room yaratish)
              </h3>
              <p>
                Yangi room yarating. Boshqa userlar sizning Room ID raqamingiz
                orqali ulanadilar.
              </p>
              <button onclick="startAsServer()" class="success">
                üöÄ Room Yaratish
              </button>
            </div>

            <div class="mode-option client">
              <h3>
                <span>üíª</span>
                Client rejimi (Roomga qo'shilish)
              </h3>
              <p>Mavjud roomga qo'shilish uchun ma'lumotlaringizni kiriting.</p>
              <input
                type="text"
                id="clientNameInput"
                placeholder="Ismingiz (masalan: Ali Valiyev)"
              />
              <input
                type="text"
                id="serverIdInput"
                placeholder="Room ID ni kiriting (masalan: ABC-123-XYZ)"
              />
              <button onclick="startAsClient()" class="success">
                üîó Roomga Qo'shilish
              </button>
            </div>
          </div>

          <div class="info-box">
            <h4>üìù Yo'riqnoma:</h4>
            <ol>
              <li>
                <strong>Server rejimi:</strong> Roomni yaratish uchun - boshqa
                userlar sizga ulanadi
              </li>
              <li>
                <strong>Client rejimi:</strong> Ism va Room ID kiriting - Roomga
                qo'shilasiz
              </li>
              <li>
                Room ID ni WhatsApp, Telegram yoki boshqa yo'l bilan ulashing
              </li>
              <li>
                Ko'p userlar bir vaqtda ulana oladi va bir-birlari bilan
                gaplasha oladi
              </li>
              <li>
                Server barcha ulangan userlarni ko'radi va ularni kuzatadi
              </li>
              <li>
                "Gapirish" tugmasi bilan mikrofonni yoqing va suhbatlashing
              </li>
              <li style="color: #fbbf24">
                üí° Test: Bir xil kompyuterda yangi tab ochib client sifatida
                ulaning
              </li>
            </ol>
          </div>
        </div>
      </div>

      <!-- Main Application Screen -->
      <div id="mainApp" class="hidden">
        <div class="card">
          <div class="header">
            <h1>
              <span>üì°</span>
              <span id="modeTitle">Signal Analizatori</span>
            </h1>
            <button
              onclick="disconnect()"
              class="danger"
              style="width: auto; padding: 12px 24px"
            >
              üö™ Chiqish
            </button>
          </div>

          <!-- Connection ID Display (Only for Server) -->
          <div id="serverIdDisplay" class="connection-id hidden">
            <div class="connection-id-label">
              üîë Sizning Room ID raqamingiz:
            </div>
            <div class="connection-id-value">
              <span id="serverId"></span>
              <button onclick="copyServerId()" class="copy-btn success">
                üìã Nusxalash
              </button>
            </div>
            <p style="color: #cbd5e1; margin-top: 12px; font-size: 14px">
              ‚ö†Ô∏è Bu Room ID ni boshqa userlarga ulashib bering. Ular bu ID
              orqali roomga qo'shiladi.
            </p>
          </div>

          <!-- Status Box -->
          <div id="statusBox" class="status-box status-disconnected">
            <span id="statusIcon">‚ùå</span>
            <span id="statusText">Ulanish kutilmoqda...</span>
          </div>

          <!-- Control Buttons -->
          <div class="grid-2">
            <button
              id="startBtn"
              onclick="startTransmission()"
              class="success"
              disabled
            >
              üé§ Gapirish
            </button>
            <button
              id="stopBtn"
              onclick="stopTransmission()"
              class="warning"
              disabled
            >
              üîá To'xtatish
            </button>
          </div>
        </div>

        <!-- Main Content -->
        <div id="statsContainer" class="hidden">
          <div class="grid-2">
            <!-- Connected Users List -->
            <div class="card" style="border-color: #8b5cf6">
              <h2 style="color: #8b5cf6">
                <span>üë•</span>
                Ulangan Userlar
                <span
                  id="userCount"
                  style="font-size: 16px; color: #a78bfa; margin-left: 8px"
                  >(0)</span
                >
              </h2>
              <div id="userList" class="user-list">
                <div class="empty-state">
                  <div class="empty-state-icon">üë§</div>
                  <p>Hali hech kim yo'q</p>
                </div>
              </div>
            </div>

            <!-- My Signal Stats and Chart -->
            <div>
              <div class="card" style="border-color: #10b981">
                <h2 style="color: #10b981">üì§ Sizning signalingiz</h2>
                <div class="grid-4">
                  <div class="stat-box" style="border-color: #10b981">
                    <div class="stat-label">Signal Kuchi</div>
                    <div class="stat-value" id="mySignal">0 dB</div>
                  </div>
                  <div class="stat-box" style="border-color: #f59e0b">
                    <div class="stat-label">Shovqin Darajasi</div>
                    <div class="stat-value" style="color: #fbbf24" id="myNoise">
                      0
                    </div>
                  </div>
                  <div class="stat-box" style="border-color: #3b82f6">
                    <div class="stat-label">Aktiv Userlar</div>
                    <div
                      class="stat-value"
                      style="color: #60a5fa"
                      id="activeUserCount"
                    >
                      0
                    </div>
                  </div>
                  <div class="stat-box" style="border-color: #8b5cf6">
                    <div class="stat-label">Holat</div>
                    <div
                      class="stat-value"
                      style="color: #a78bfa; font-size: 20px"
                      id="myStatus"
                    >
                      üîá Tinch
                    </div>
                  </div>
                </div>
              </div>

              <div class="card" style="border-color: #10b981">
                <h2 style="color: #10b981">üìä Signal Tarixi</h2>
                <div class="chart-container">
                  <canvas id="signalChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <audio id="remoteAudio" autoplay></audio>

    <script>
      // ==================== GLOBAL VARIABLES ====================
      let mode = null;
      let myUserId = null;
      let myUserName = null;
      let roomId = null;
      let isConnected = false;
      let isTransmitting = false;

      let audioContext = null;
      let analyser = null;
      let micStream = null;
      let animationFrame = null;

      let signalChart = null;
      let signalHistory = [];

      let connectedUsers = new Map();
      let checkUsersInterval = null;

      // PeerJS
      let peer = null;
      let connections = new Map(); // peerId -> connection
      let audioStreams = new Map(); // peerId -> stream

      // ==================== UTILITY FUNCTIONS ====================
      function generateId() {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let id = "";
        for (let i = 0; i < 3; i++) {
          if (i > 0) id += "-";
          for (let j = 0; j < 3; j++) {
            id += chars.charAt((Math.random() * chars.length) | 0);
          }
        }
        return id;
      }

      function getSignalColor(strength) {
        if (strength > 70) return "#10b981";
        if (strength > 40) return "#f59e0b";
        return "#ef4444";
      }

      function updateStatus(icon, text) {
        document.getElementById("statusIcon").textContent = icon;
        document.getElementById("statusText").textContent = text;

        const statusBox = document.getElementById("statusBox");
        if (icon === "‚úÖ" || icon === "üü¢") {
          statusBox.classList.remove("status-disconnected");
          statusBox.classList.add("status-connected");
        } else {
          statusBox.classList.remove("status-connected");
          statusBox.classList.add("status-disconnected");
        }
      }

      // ==================== MODE SELECTION ====================
      function startAsServer() {
        mode = "server";
        myUserName = "Server Admin";

        // PeerJS ulanish
        peer = new Peer({
          config: {
            iceServers: [
              { urls: "stun:stun.l.google.com:19302" },
              { urls: "stun:stun1.l.google.com:19302" },
            ],
          },
        });

        peer.on("open", function (id) {
          myUserId = id;
          roomId = id.substring(0, 8).toUpperCase(); // Qisqa ID

          // Roomni LocalStorage'ga saqlash
          const roomData = {
            roomId: roomId,
            peerId: id,
            createdBy: myUserId,
            createdAt: Date.now(),
            isActive: true,
          };
          localStorage.setItem(
            "radioaloqa_room_" + roomId,
            JSON.stringify(roomData)
          );

          document.getElementById("modeSelector").classList.add("hidden");
          document.getElementById("mainApp").classList.remove("hidden");
          document.getElementById("modeTitle").textContent = "üñ•Ô∏è Server Rejimi";

          document.getElementById("serverIdDisplay").classList.remove("hidden");
          document.getElementById("serverId").textContent = roomId;

          updateStatus("üü¢", "Server ishga tushdi - Room ID: " + roomId);

          initCharts();

          isConnected = true;
          document.getElementById("startBtn").disabled = false;
          document.getElementById("statsContainer").classList.remove("hidden");

          connectedUsers.set(myUserId, {
            name: myUserName + " (Siz)",
            isTransmitting: false,
            stats: { signal: 0, noise: 0 },
          });

          updateUserList();
        });

        // Yangi ulanishlarni qabul qilish
        peer.on("connection", function (conn) {
          handleNewConnection(conn);
        });

        peer.on("call", function (call) {
          handleIncomingCall(call);
        });

        peer.on("error", function (err) {
          console.error("PeerJS error:", err);
          alert("‚ùå Ulanishda xato: " + err.type);
        });
      }

      function startAsClient() {
        const clientName = document
          .getElementById("clientNameInput")
          .value.trim();
        const serverIdInput = document
          .getElementById("serverIdInput")
          .value.trim()
          .toUpperCase();

        if (!clientName) {
          alert("‚ö†Ô∏è Iltimos, ismingizni kiriting!");
          return;
        }

        if (!serverIdInput) {
          alert("‚ö†Ô∏è Iltimos, Room ID ni kiriting!");
          return;
        }

        // Room ID mavjudligini tekshirish
        const roomKey = "radioaloqa_room_" + serverIdInput;
        const roomData = localStorage.getItem(roomKey);

        if (!roomData) {
          alert(
            "‚ùå Bunday Room ID mavjud emas!\n\nIltimos, to'g'ri Room ID ni kiriting."
          );
          return;
        }

        const room = JSON.parse(roomData);
        if (!room.isActive) {
          alert("‚ùå Bu room yopilgan!\n\nIltimos, faol roomga ulaning.");
          return;
        }

        mode = "client";
        myUserName = clientName;
        roomId = serverIdInput;
        const serverPeerId = room.peerId;

        document.getElementById("modeSelector").classList.add("hidden");
        document.getElementById("mainApp").classList.remove("hidden");
        document.getElementById("modeTitle").textContent =
          "üíª " + clientName + " - Room: " + roomId;

        updateStatus("üü°", "Roomga ulanilmoqda...");

        initCharts();

        // PeerJS ulanish
        peer = new Peer({
          config: {
            iceServers: [
              { urls: "stun:stun.l.google.com:19302" },
              { urls: "stun:stun1.l.google.com:19302" },
            ],
          },
        });

        peer.on("open", function (id) {
          myUserId = id;

          // Serverga ulanish
          const conn = peer.connect(serverPeerId);

          conn.on("open", function () {
            isConnected = true;
            updateStatus("‚úÖ", "Roomga muvaffaqiyatli ulandi!");
            document.getElementById("startBtn").disabled = false;
            document
              .getElementById("statsContainer")
              .classList.remove("hidden");

            // O'z ma'lumotlarimizni yuborish
            conn.send({
              type: "user-info",
              userId: myUserId,
              userName: myUserName,
            });

            connectedUsers.set(myUserId, {
              name: myUserName + " (Siz)",
              isTransmitting: false,
              stats: { signal: 0, noise: 0 },
            });

            connections.set(serverPeerId, conn);
            updateUserList();
          });

          conn.on("data", function (data) {
            handleDataMessage(data, conn);
          });
        });

        peer.on("connection", function (conn) {
          handleNewConnection(conn);
        });

        peer.on("call", function (call) {
          handleIncomingCall(call);
        });

        peer.on("error", function (err) {
          console.error("PeerJS error:", err);
          alert("‚ùå Ulanishda xato: " + err.type);
        });
      }

      // ==================== USER MANAGEMENT ====================
      function handleNewConnection(conn) {
        connections.set(conn.peer, conn);

        conn.on("data", function (data) {
          handleDataMessage(data, conn);
        });

        conn.on("close", function () {
          connections.delete(conn.peer);
          connectedUsers.delete(conn.peer);
          updateUserList();
        });
      }

      function handleDataMessage(data, conn) {
        if (data.type === "user-info") {
          connectedUsers.set(data.userId, {
            name: data.userName,
            isTransmitting: false,
            stats: { signal: 0, noise: 0 },
          });
          updateUserList();
          showNotification("‚úÖ Yangi user qo'shildi: " + data.userName);

          // Server bo'lsak, boshqa clientlarga xabar beramiz
          if (mode === "server") {
            broadcastToOthers(
              {
                type: "user-joined",
                userId: data.userId,
                userName: data.userName,
              },
              data.userId
            );

            // Yangi userga mavjud userlar ro'yxatini yuboramiz
            const userList = [];
            connectedUsers.forEach((user, userId) => {
              if (userId !== data.userId) {
                userList.push({
                  userId,
                  userName: user.name.replace(" (Siz)", ""),
                });
              }
            });
            conn.send({
              type: "user-list",
              users: userList,
            });
          }
        } else if (data.type === "user-joined") {
          connectedUsers.set(data.userId, {
            name: data.userName,
            isTransmitting: false,
            stats: { signal: 0, noise: 0 },
          });
          updateUserList();
          showNotification("‚úÖ Yangi user qo'shildi: " + data.userName);
        } else if (data.type === "user-list") {
          data.users.forEach((user) => {
            if (!connectedUsers.has(user.userId)) {
              connectedUsers.set(user.userId, {
                name: user.userName,
                isTransmitting: false,
                stats: { signal: 0, noise: 0 },
              });
            }
          });
          updateUserList();
        } else if (data.type === "signal-update") {
          const user = connectedUsers.get(data.userId);
          if (user) {
            user.isTransmitting = data.isTransmitting;
            user.stats = data.stats;
            updateUserList();
          }
        }
      }

      function handleIncomingCall(call) {
        // Audio stream qabul qilish
        call.answer();

        call.on("stream", function (remoteStream) {
          audioStreams.set(call.peer, remoteStream);

          // Audio element yaratish va eshitish
          const audio = document.createElement("audio");
          audio.srcObject = remoteStream;
          audio.autoplay = true;
          audio.id = "audio-" + call.peer;
          document.body.appendChild(audio);
        });

        call.on("close", function () {
          audioStreams.delete(call.peer);
          const audio = document.getElementById("audio-" + call.peer);
          if (audio) audio.remove();
        });
      }

      function broadcastToOthers(message, excludeUserId) {
        connections.forEach((conn, peerId) => {
          if (peerId !== excludeUserId) {
            conn.send(message);
          }
        });
      }

      function broadcastSignalUpdate() {
        const myUser = connectedUsers.get(myUserId);
        if (myUser) {
          const message = {
            type: "signal-update",
            userId: myUserId,
            isTransmitting: isTransmitting,
            stats: myUser.stats,
          };
          connections.forEach((conn) => {
            conn.send(message);
          });
        }
      }

      function checkForNewUsers() {
        // LocalStorage'dan barcha userlarni tekshirish
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith("radioaloqa_user_")) {
            try {
              const data = JSON.parse(localStorage.getItem(key));

              // To'g'ri room va yangi user ekanligini tekshirish
              if (
                data &&
                data.roomId === roomId &&
                !connectedUsers.has(data.userId)
              ) {
                // O'zimiz emasligini tekshirish
                if (data.userId !== myUserId) {
                  connectedUsers.set(data.userId, {
                    name: data.userName,
                    isTransmitting: data.isTransmitting || false,
                    stats: data.stats || { signal: 0, noise: 0 },
                  });
                  updateUserList();
                  showNotification("‚úÖ Yangi user qo'shildi: " + data.userName);
                }
              }

              // Eski userlarni yangilash (signal ma'lumotlari)
              if (
                data &&
                data.roomId === roomId &&
                connectedUsers.has(data.userId) &&
                data.userId !== myUserId
              ) {
                const user = connectedUsers.get(data.userId);
                if (user) {
                  user.isTransmitting = data.isTransmitting || false;
                  user.stats = data.stats || { signal: 0, noise: 0 };
                  updateUserList();
                }
              }
            } catch (e) {
              console.error("User data parse error:", e);
            }
          }
        }
      }

      function updateMyUserData() {
        // O'z ma'lumotimizni yangilash
        if (myUserId && roomId) {
          const myUser = connectedUsers.get(myUserId);
          const myUserData = {
            userId: myUserId,
            userName: myUserName,
            roomId: roomId,
            isTransmitting: isTransmitting,
            stats: myUser ? myUser.stats : { signal: 0, noise: 0 },
            timestamp: Date.now(),
          };
          localStorage.setItem(
            "radioaloqa_user_" + myUserId,
            JSON.stringify(myUserData)
          );
        }
      }

      function showNotification(message) {
        // Notification ko'rsatish
        const notification = document.createElement("div");
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(16, 185, 129, 0.9);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      function updateUserList() {
        const userListDiv = document.getElementById("userList");
        const userCountSpan = document.getElementById("userCount");

        if (!userListDiv) return;

        const userCount = connectedUsers.size;
        userCountSpan.textContent = `(${userCount})`;

        if (userCount === 0) {
          userListDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <p>Hali hech kim yo'q</p>
                    </div>
                `;
          return;
        }

        let html = "";
        connectedUsers.forEach((user, userId) => {
          const isSelf = userId === myUserId;
          const statusIcon = user.isTransmitting ? "üé§" : "üîá";
          const statusText = user.isTransmitting ? "Gapirmoqda" : "Tinch";
          const statusColor = user.isTransmitting ? "#10b981" : "#64748b";
          const cardClass = isSelf ? "user-card self" : "user-card";
          const speakingClass = user.isTransmitting ? " speaking" : "";
          const userLabel = isSelf ? " (Siz)" : "";

          html += `
                    <div class="${cardClass}${speakingClass}">
                        <div class="user-header">
                            <div>
                                <div class="user-name">${
                                  isSelf ? "üë§ " : "üë®‚Äçüíº "
                                }${user.name}${userLabel}</div>
                                <div class="user-status" style="color: ${statusColor};">
                                    <span class="status-indicator ${
                                      user.isTransmitting
                                        ? "active"
                                        : "inactive"
                                    }"></span>
                                    ${statusIcon} ${statusText}
                                </div>
                            </div>
                        </div>
                        ${
                          user.isTransmitting
                            ? `
                            <div class="user-stats-grid">
                                <div class="user-stat">
                                    <div class="user-stat-label">Signal</div>
                                    <div class="user-stat-value" style="color: ${getSignalColor(
                                      user.stats.signal
                                    )};">
                                        ${user.stats.signal.toFixed(1)} dB
                                    </div>
                                </div>
                                <div class="user-stat">
                                    <div class="user-stat-label">Shovqin</div>
                                    <div class="user-stat-value">${Math.round(
                                      user.stats.noise
                                    )}</div>
                                </div>
                            </div>
                            <div class="volume-meter">
                                <div class="volume-meter-fill" style="width: ${
                                  user.stats.signal
                                }%;"></div>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;
        });

        userListDiv.innerHTML = html;
        updateActiveUserCount();
      }

      function updateActiveUserCount() {
        let activeCount = 0;
        connectedUsers.forEach((user) => {
          if (user.isTransmitting) activeCount++;
        });
        document.getElementById("activeUserCount").textContent = activeCount;
      }

      // ==================== AUDIO TRANSMISSION ====================
      async function startTransmission() {
        if (!isConnected) {
          alert("‚ö†Ô∏è Avval ulanish o'rnating!");
          return;
        }

        try {
          micStream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true,
              sampleRate: 48000,
            },
          });

          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 2048;
          analyser.smoothingTimeConstant = 0.8;

          const source = audioContext.createMediaStreamSource(micStream);
          source.connect(analyser);

          isTransmitting = true;
          document.getElementById("startBtn").disabled = true;
          document.getElementById("stopBtn").disabled = false;
          document.getElementById("myStatus").textContent = "üé§ Gapirmoqda";
          document.getElementById("myStatus").style.color = "#10b981";

          const myUser = connectedUsers.get(myUserId);
          if (myUser) {
            myUser.isTransmitting = true;
            updateUserList();
          }

          // Audio streamni boshqalarga yuborish
          connections.forEach((conn, peerId) => {
            const call = peer.call(peerId, micStream);
            call.on("error", function (err) {
              console.error("Call error:", err);
            });
          });

          analyzeAudio();
        } catch (err) {
          console.error("Mikrofon xatosi:", err);
          alert(
            "‚ùå Mikrofondan foydalanishda xato yuz berdi! Brauzerda mikrofon ruxsatini tekshiring."
          );
        }
      }

      function stopTransmission() {
        if (micStream) {
          micStream.getTracks().forEach((track) => track.stop());
          micStream = null;
        }

        if (animationFrame) {
          cancelAnimationFrame(animationFrame);
          animationFrame = null;
        }

        isTransmitting = false;
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        document.getElementById("myStatus").textContent = "üîá Tinch";
        document.getElementById("myStatus").style.color = "#64748b";

        const myUser = connectedUsers.get(myUserId);
        if (myUser) {
          myUser.isTransmitting = false;
          updateUserList();
        }

        // Ma'lumotlarni yangilash
        updateMyUserData();
      }

      function analyzeAudio() {
        if (!analyser || !isTransmitting) return;

        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        const timeData = new Uint8Array(bufferLength);

        analyser.getByteFrequencyData(dataArray);
        analyser.getByteTimeDomainData(timeData);

        // Calculate RMS for signal strength
        let sum = 0;
        for (let i = 0; i < timeData.length; i++) {
          const normalized = (timeData[i] - 128) / 128;
          sum += normalized * normalized;
        }
        const rms = Math.sqrt(sum / timeData.length);
        const dbValue = 20 * Math.log10(rms + 0.0001);
        const normalizedDb = Math.max(0, Math.min(100, (dbValue + 60) * 1.67));

        // Calculate noise floor
        const sortedData = Array.from(dataArray).sort((a, b) => a - b);
        const noiseFloor =
          sortedData
            .slice(0, Math.floor(sortedData.length * 0.1))
            .reduce((a, b) => a + b, 0) /
          (sortedData.length * 0.1);

        // Update UI
        document.getElementById("mySignal").textContent =
          normalizedDb.toFixed(1) + " dB";
        document.getElementById("mySignal").style.color =
          getSignalColor(normalizedDb);
        document.getElementById("myNoise").textContent = Math.round(noiseFloor);

        // Update user stats
        const myUser = connectedUsers.get(myUserId);
        if (myUser) {
          myUser.stats = {
            signal: normalizedDb,
            noise: noiseFloor,
          };
          updateUserList();
        }

        // Ma'lumotlarni yangilash
        updateMyUserData();

        // Update chart
        updateSignalChart(normalizedDb);

        animationFrame = requestAnimationFrame(analyzeAudio);
      }

      // ==================== CHARTS ====================
      function initCharts() {
        const signalCtx = document
          .getElementById("signalChart")
          .getContext("2d");
        signalChart = new Chart(signalCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Signal Kuchi (dB)",
                data: [],
                borderColor: "#10b981",
                backgroundColor: "rgba(16, 185, 129, 0.1)",
                tension: 0.4,
                fill: true,
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                grid: { color: "#334155" },
                ticks: { color: "#94a3b8" },
                title: {
                  display: true,
                  text: "Signal (dB)",
                  color: "#94a3b8",
                },
              },
              x: {
                grid: { color: "#334155" },
                ticks: {
                  color: "#94a3b8",
                  maxRotation: 0,
                  maxTicksLimit: 10,
                },
              },
            },
            plugins: {
              legend: {
                labels: { color: "#94a3b8" },
              },
            },
          },
        });
      }

      function updateSignalChart(signal) {
        const now = new Date().toLocaleTimeString("uz-UZ", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

        signalHistory.push({ time: now, signal });
        if (signalHistory.length > 30) signalHistory.shift();

        signalChart.data.labels = signalHistory.map((h) => h.time);
        signalChart.data.datasets[0].data = signalHistory.map((h) => h.signal);
        signalChart.update("none");
      }

      // ==================== HELPER FUNCTIONS ====================
      function copyServerId() {
        const id = document.getElementById("serverId").textContent;
        navigator.clipboard
          .writeText(id)
          .then(() => {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = "‚úÖ Nusxalandi!";
            btn.style.background = "#059669";
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.style.background = "";
            }, 2000);
          })
          .catch(() => {
            alert(
              "Room ID: " +
                id +
                "\n\nBu ID ni qo'lda nusxalang va boshqa userlarga yuboring."
            );
          });
      }

      function disconnect() {
        stopTransmission();

        // Intervalni to'xtatish
        if (checkUsersInterval) {
          clearInterval(checkUsersInterval);
          checkUsersInterval = null;
        }

        // LocalStorage'dan o'z ma'lumotimizni o'chirish
        if (myUserId) {
          localStorage.removeItem("radioaloqa_user_" + myUserId);
        }

        // Agar server bo'lsak, roomni ham o'chiramiz
        if (mode === "server" && roomId) {
          const roomKey = "radioaloqa_room_" + roomId;
          const roomData = localStorage.getItem(roomKey);
          if (roomData) {
            const room = JSON.parse(roomData);
            room.isActive = false;
            localStorage.setItem(roomKey, JSON.stringify(room));
          }
        }

        connectedUsers.clear();

        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }

        isConnected = false;
        mode = null;
        myUserId = null;
        myUserName = null;
        roomId = null;
        signalHistory = [];

        document.getElementById("mainApp").classList.add("hidden");
        document.getElementById("modeSelector").classList.remove("hidden");
        document.getElementById("serverIdDisplay").classList.add("hidden");
        document.getElementById("statsContainer").classList.add("hidden");
        document.getElementById("serverIdInput").value = "";
        document.getElementById("clientNameInput").value = "";
      }

      // ==================== INITIALIZATION ====================
      console.log("üì° Radioaloqa Multi-User Chat ishga tushdi!");
      console.log("üí° Room yarating yoki mavjud roomga qo'shiling");
    </script>
  </body>
</html>
